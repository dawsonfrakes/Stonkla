<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stonkla</title>
</head>
<body>
  <script type="module">
    import {createElement, createContext, useState, useEffect, useRef, useContext, useId} from "https://esm.sh/react@19.0.0";
    import ReactDOMClient from "https://esm.sh/react-dom@19.0.0/client";
    const h = createElement;

    import {Chart} from "https://esm.sh/chart.js@4.4.7";

    const DB = (() => {
      const ondbchange = new CustomEvent("ondbchange");
      const inner = new Promise((resolve, reject) => {
        const request = indexedDB.open("stonkla", 1);
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => resolve(e.target.error);
        request.onupgradeneeded = e => {
          const db = e.target.result;
          if (db.version >= 1) {
            const store = db.createObjectStore("trades", {keyPath: "id", autoIncrement: true});
            store.createIndex("symbol", "symbol");
            store.createIndex("executions", "executions");
            store.createIndex("tags", "tags");
          }
        };
      });
      return {
        add: (store, value) => inner.then(db => db.transaction(store, "readwrite").objectStore(store).add(value)).then(request => (request.onsuccess = () => document.dispatchEvent(ondbchange))),
        bulkAdd: (store, values) => inner.then(db => { const tx = db.transaction(store, "readwrite"); values.forEach(value => tx.objectStore(store).add(value)); return tx; }).then(request => (request.onsuccess = () => document.dispatchEvent(ondbchange))),
        put: (store, value) => inner.then(db => db.transaction(store, "readwrite").objectStore(store).put(value)).then(request => (request.onsuccess = () => document.dispatchEvent(ondbchange))),
        delete: (store, id) => inner.then(db => db.transaction(store, "readwrite").objectStore(store).delete(id)).then(request => (request.onsuccess = () => document.dispatchEvent(ondbchange))),
        clear: store => inner.then(db => db.transaction(store, "readwrite").objectStore(store).clear()).then(request => (request.onsuccess = () => document.dispatchEvent(ondbchange))),
        get: (store, id) => inner.then(db => db.transaction(store).objectStore(store).get(id)),
        getAll: store => inner.then(db => db.transaction(store).objectStore(store).getAll()),
      };
    })();

    const TRANSLATIONS = {
      "en": {
        "translation-name": "English",
        "app-add-trade-button": "Add Trade",
        "app-import-export-button": "Import/Export",
        "app-open-settings-button": "Settings",
        "trade-entry-header-text": "Trade Entry",
        "trade-entry-close-button": "Close",
        "trade-entry-symbol-placeholder": "Symbol",
        "trade-entry-symbol-label": "Symbol:",
        "trade-entry-tags-placeholder": "Tags",
        "trade-entry-tags-label": "Tags:",
        "trade-entry-remove-execution-button": "Remove",
        "trade-entry-action-buy-button": "BUY",
        "trade-entry-action-sell-button": "SELL",
        "trade-entry-time-label": "Time:",
        "trade-entry-quantity-label": "Quantity:",
        "trade-entry-price-label": "Price:",
        "trade-entry-fees-label": "Fees:",
        "trade-entry-add-execution-button": "Add Execution",
        "trade-entry-save-button": "Save",
        "app-settings-header-text": "Settings",
        "app-settings-close-button": "Close",
        "app-settings-locale-label": "Locale:",
        "app-settings-theme-label": "Theme:",
        "app-settings-currency-label": "Currency:",
        "trade-table-time-header": "Time",
        "trade-table-symbol-header": "Symbol",
        "trade-table-entry-total-header": "Entry Total",
        "trade-table-exit-total-header": "Exit Total",
        "trade-table-net-profit-loss-header": "Net P/L",
        "trade-table-edit-header": "Edit",
        "trade-table-remove-header": "Remove",
        "trade-stats-total-profit-loss-label": "Total Profit/Loss:",
        "trade-stats-total-trades-label": "Total Trades:",
        "trade-stats-win-count-label": "Win Count:",
        "trade-stats-loss-count-label": "Loss Count:",
        "trade-stats-win-percentage-label": "Win Percentage:",
        "trade-stats-largest-win-label": "Largest Win:",
        "trade-stats-largest-loss-label": "Largest Loss:",
        "trade-stats-average-win-label": "Average Win:",
        "trade-stats-average-loss-label": "Average Loss:",
      },
    };

    const THEMES = {
      "gray-matter": {
        "background-primary": "#343434",
        "background-secondary": "#232323",
        "text-primary": "#cdcdcd",
        "text-secondary": "#fefefe",
        "accent": "#cc6655",
      },
    };

    const currentMinute = () => {
      const date = new Date(new Date() - new Date().getTimezoneOffset() * 60 * 1000);
      date.setSeconds(0, 0);
      return date.toISOString().slice(0, -1);
    };
    const prepareTrade = trade => ({
      ...trade,
      executions: trade.executions.map(execution => ({
        ...execution,
        quantity: parseFloat(execution.quantity),
        price: parseFloat(execution.price),
        fees: parseFloat(execution.fees),
      })),
      tags: trade.tags.filter(tag => tag !== ""),
    });

    const LocaleContext = createContext(null);
    const ThemeContext = createContext(null);

    const TradeTable = ({trades, editTrade, removeTrade}) => {
      const {T, C, locale} = useContext(LocaleContext);

      const entryTotal = trade => trade.executions.filter(execution => execution.action === "BUY").reduce((acc, execution) => execution.quantity * execution.price + execution.fees, 0);
      const exitTotal = trade => trade.executions.filter(execution => execution.action === "SELL").reduce((acc, execution) => execution.quantity * execution.price - execution.fees, 0);

      return h("div", {className: "trade-table"},
        h("table", null,
          h("thead", null,
            h("tr", null,
              h("th", null, T("trade-table-time-header")),
              h("th", null, T("trade-table-symbol-header")),
              h("th", null, T("trade-table-entry-total-header")),
              h("th", null, T("trade-table-exit-total-header")),
              h("th", null, T("trade-table-net-profit-loss-header")),
              h("th", null, T("trade-table-edit-header")),
              h("th", null, T("trade-table-remove-header")),
            ),
          ),
          h("tbody", null,
            trades.map(trade => h("tr", null,
              h("td", null, new Date(trade.executions[0].time).toLocaleString(locale)),
              h("td", null, trade.symbol),
              h("td", null, C(entryTotal(trade))),
              h("td", null, C(exitTotal(trade))),
              h("td", null, C(exitTotal(trade) - entryTotal(trade))),
              h("td", null, h("button", {onClick: () => editTrade(trade)}, "Edit")),
              h("td", null, h("button", {onClick: () => removeTrade(trade)}, "Remove")),
            )),
          ),
        ),
      );
    };

    const TradeStats = ({trades}) => {
      const {T, C, P} = useContext(LocaleContext);

      const netProfitLosses = trades.map(trade => trade.executions.reduce((acc, execution) => acc + execution.quantity * execution.price * (execution.action === "BUY" ? -1 : 1) - execution.fees, 0));
      const wins = netProfitLosses.filter(net => net >= 0.0);
      const losses = netProfitLosses.filter(net => net < 0.0);

      return h("div", {className: "trade-stats"},
        h("span", null, `${T("trade-stats-total-profit-loss-label")} ${C(netProfitLosses.reduce((acc, net) => acc + net, 0))}`),
        h("span", null, `${T("trade-stats-total-trades-label")} ${netProfitLosses.length}`),
        h("span", null, `${T("trade-stats-win-count-label")} ${wins.length}`),
        h("span", null, `${T("trade-stats-loss-count-label")} ${losses.length}`),
        h("span", null, `${T("trade-stats-win-percentage-label")} ${P(wins.length / (netProfitLosses.length || 1))}`),
        h("span", null, `${T("trade-stats-largest-win-label")} ${C(wins.reduce((acc, win) => Math.max(acc, win), 0))}`),
        h("span", null, `${T("trade-stats-largest-loss-label")} ${C(losses.reduce((acc, loss) => Math.min(acc, loss), 0))}`),
        h("span", null, `${T("trade-stats-average-win-label")} ${C(wins.reduce((acc, win) => acc + win, 0) / (wins.length || 1))}`),
        h("span", null, `${T("trade-stats-average-loss-label")} ${C(losses.reduce((acc, loss) => acc + loss, 0) / (losses.length || 1))}`),
      );
    };

    const TradeEntry = ({trade, setTrade, onSaveTrade, closeSelf}) => {
      const id = useId();
      const {T} = useContext(LocaleContext);
      const dialogRef = useRef(null);
      const symbolRef = useRef(null);

      const addExecution = () => {
        const executions = [...trade.executions];
        executions.push({
          action: executions.length > 0 && executions[executions.length - 1].action === "BUY" ? "SELL" : "BUY",
          time: executions.length > 0 ? executions[executions.length - 1].time : currentMinute(),
          quantity: executions.length > 0 ? executions[executions.length - 1].quantity : "",
          price: "",
          fees: "",
        });
        setTrade({...trade, executions});
      };
      const updateExecution = (i, value) => {
        const executions = [...trade.executions];
        Object.assign(executions[i], value);
        setTrade({...trade, executions});
      };
      const removeExecution = i => {
        const executions = [...trade.executions.slice(0, i), ...trade.executions.slice(i + 1)];
        setTrade({...trade, executions});
      };
      const onSubmit = e => {
        e.preventDefault();
        onSaveTrade(trade);
        closeSelf();
      };

      useEffect(() => {
        dialogRef.current.showModal();
        symbolRef.current.focus();
      }, []);
      useEffect(() => { if (trade.executions.length === 0) addExecution(); }, []);

      return h("dialog", {ref: dialogRef, onCancel: closeSelf},
        h("div", {className: "flex-header"},
          h("h2", null, T("trade-entry-header-text")),
          h("span", {className: "flex-grow"}),
          h("button", {onClick: closeSelf}, T("trade-entry-close-button")),
        ),
        h("form", {className: "flex-column", onSubmit},
          h("label", {htmlFor: id + "-symbol"}, T("trade-entry-symbol-label")),
          h("input", {id: id + "-symbol", ref: symbolRef, type: "text", required: true, placeholder: T("trade-entry-symbol-placeholder"), value: trade.symbol, onChange: e => setTrade({...trade, symbol: e.target.value.replace(/,/g, "").toUpperCase()})}),
          h("label", {htmlFor: id + "-tags"}, T("trade-entry-tags-label")),
          h("input", {id: id + "-tags", type: "text", placeholder: T("trade-entry-tags-placeholder"), value: trade.tags.join(";"), onChange: e => setTrade({...trade, tags: e.target.value.split(";")})}),
          trade.executions.map((execution, i) => h("div", {key: i, className: "flex-column trade-execution"},
            h("button", {type: "button", onClick: () => removeExecution(i), disabled: trade.executions.length === 1}, T("trade-entry-remove-execution-button")),
            h("button", {type: "button", onClick: () => updateExecution(i, {action: execution.action === "BUY" ? "SELL" : "BUY"})}, execution.action === "BUY" ? T("trade-entry-action-buy-button") : T("trade-entry-action-sell-button")),
            h("label", {htmlFor: id + "-time-" + i}, T("trade-entry-time-label")),
            h("input", {id: id + "-time-" + i, type: "datetime-local", required: true, step: "1", value: execution.time, onChange: e => updateExecution(i, {time: e.target.value})}),
            h("label", {htmlFor: id + "-quantity-" + i}, T("trade-entry-quantity-label")),
            h("input", {id: id + "-quantity-" + i, type: "text", required: true, value: execution.quantity, onChange: e => updateExecution(i, {quantity: e.target.value})}),
            h("label", {htmlFor: id + "-price-" + i}, T("trade-entry-price-label")),
            h("input", {id: id + "-price-" + i, type: "text", required: true, value: execution.price, onChange: e => updateExecution(i, {price: e.target.value})}),
            h("label", {htmlFor: id + "-fees-" + i}, T("trade-entry-fees-label")),
            h("input", {id: id + "-fees-" + i, type: "text", required: true, value: execution.fees, onChange: e => updateExecution(i, {fees: e.target.value})}),
            )),
          h("button", {type: "button", onClick: addExecution}, T("trade-entry-add-execution-button")),
          h("button", null, T("trade-entry-save-button")),
        ),
      );
    };

    const AppSettings = ({closeSelf}) => {
      const id = useId();
      const {T, locale, setLocale, currency, setCurrency} = useContext(LocaleContext);
      const {theme, setTheme} = useContext(ThemeContext);
      const dialogRef = useRef(null);

      useEffect(() => dialogRef.current.showModal(), []);

      return h("dialog", {ref: dialogRef, onCancel: closeSelf},
        h("div", {className: "flex-header"},
          h("h2", null, T("app-settings-header-text")),
          h("span", {className: "flex-grow"}),
          h("button", {onClick: closeSelf}, T("app-settings-close-button")),
        ),
        h("div", {className: "flex-column"},
          h("label", {htmlFor: id + "-locale"}, T("app-settings-locale-label")),
          h("select", {id: id + "-locale", defaultValue: locale, onChange: e => setLocale(e.target.value)},
            Object.keys(TRANSLATIONS).map(l => h("option", {key: l, value: l}, TRANSLATIONS[l]["translation-name"])),
          ),
          h("label", {htmlFor: id + "-theme"}, T("app-settings-theme-label")),
          h("select", {id: id + "-theme", defaultValue: theme, onChange: e => setTheme(e.target.value)},
            Object.keys(THEMES).map(t => h("option", {key: t, value: t}, t)),
          ),
          h("label", {htmlFor: id + "-currency"}, T("app-settings-currency-label")),
          h("select", {id: id + "-currency", defaultValue: currency, onChange: e => setCurrency(e.target.value)},
            ["USD", "CAD", "GBP", "EUR", "JPY"].map(c => h("option", {key: c, value: c}, c)),
          ),
        ),
      );
    };

    const App = () => {
      const defaultLocale = localStorage.getItem("locale") ?? navigator.language.slice(0, 2);
      const defaultTheme = localStorage.getItem("theme") ?? "gray-matter";

      const [locale, setLocale] = useState(defaultLocale in TRANSLATIONS ? defaultLocale : Object.keys(TRANSLATIONS)[0]);
      const [theme, setTheme] = useState(defaultTheme in THEMES ? defaultTheme : Object.keys(THEMES)[0]);
      const [currency, setCurrency] = useState(localStorage.getItem("currency") ?? "USD");
      const [showAppSettings, setShowAppSettings] = useState(false);
      const [showTradeEntry, setShowTradeEntry] = useState(false);
      const [editingTrade, setEditingTrade] = useState(null);
      const [onEditingTradeSave, setOnEditingTradeSave] = useState(null);
      const [trades, setTrades] = useState([]);

      const T = key => TRANSLATIONS[locale][key] ?? console.error(`Key "${key}" not found in locale "${locale}".`);
      const S = key => THEMES[theme][key] ?? console.error(`Key "${key}" not found in theme "${theme}".`);
      const C = amount => new Intl.NumberFormat(locale, {style: "currency", currency}).format(amount);
      const P = amount => new Intl.NumberFormat(locale, {style: "percent", maximumFractionDigits: 2}).format(amount);

      const addTrade = () => {
        setEditingTrade({
          symbol: "",
          executions: [],
          tags: [],
        });
        setOnEditingTradeSave(() => trade => DB.add("trades", prepareTrade(trade)));
        setShowTradeEntry(true);
      };
      const editTrade = trade => {
        setEditingTrade(structuredClone(trade));
        setOnEditingTradeSave(() => trade => DB.put("trades", prepareTrade(trade)));
        setShowTradeEntry(true);
      };
      const removeTrade = trade => DB.delete("trades", trade.id);

      useEffect(() => localStorage.setItem("locale", locale), [locale]);
      useEffect(() => localStorage.setItem("theme", theme), [theme]);
      useEffect(() => localStorage.setItem("currency", currency), [currency]);
      useEffect(() => {
        const handler = () => DB.getAll("trades").then(request => (request.onsuccess = e => setTrades(e.target.result)));
        handler();
        document.addEventListener("ondbchange", handler);
        return () => document.removeEventListener("ondbchange", handler);
      }, []);

      return h(LocaleContext.Provider, {value: {T, C, P, locale, setLocale, currency, setCurrency}},
        h(ThemeContext.Provider, {value: {S, theme, setTheme}},
          h("style", null, `
            @import url('https://fonts.googleapis.com/css2?family=Inter:opsz@14..32&display=swap');

            body, dialog {
              font-family: "Inter", sans-serif;
              background-color: ${S("background-primary")};
              color: ${S("text-primary")};
            }

            a {
              color: ${S("accent")};
            }

            dialog {
              border-radius: 10px;
            }

            table {
              width: fit-content;
              margin: 0 auto;
              text-wrap: nowrap;
              border-collapse: collapse;
            }

            thead {
              border-bottom: 2px solid;
            }

            th {
              text-align: start;
            }

            th, td {
              border: 1px solid;
              padding: 5px;
            }

            footer {
              margin: 10px;
              text-align: center;
            }

            .trade-table {
              overflow: auto;
            }

            .trade-stats {
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
            }

            .trade-stats * {
              background-color: ${S("background-secondary")};
              padding: 15px;
              margin: 10px;
              border-radius: 15px;
              border: 2px solid ${S("text-primary")};
            }

            .flex-header {
              display: flex;
              align-items: center;
            }

            .flex-header *:not(:last-child) {
              margin-right: 5px;
            }

            .flex-grow {
              flex-grow: 1;
            }

            .flex-column {
              display: flex;
              flex-direction: column;
            }

            .trade-execution {
              background-color: ${S("background-secondary")};
              margin: 10px 0;
              padding: 10px;
              border-radius: 10px;
            }
          `),
          h("div", {className: "flex-header"},
            h("h1", null, "Stonkla"),
            h("span", {className: "flex-grow"}),
            h("button", {onClick: addTrade}, T("app-add-trade-button")),
            h("button", null, T("app-import-export-button")),
            h("button", {onClick: () => setShowAppSettings(true)}, T("app-open-settings-button")),
          ),
          showAppSettings && h(AppSettings, {closeSelf: () => setShowAppSettings(false)}),
          showTradeEntry && h(TradeEntry, {trade: editingTrade, setTrade: setEditingTrade, onSaveTrade: onEditingTradeSave, closeSelf: () => setShowTradeEntry(false)}),
          h(TradeStats, {trades}),
          h(TradeTable, {trades, editTrade, removeTrade}),
          h("footer", null,
            "Made with ❤️ by Dfra",
            h("br"),
            h("a", {href: "https://github.com/sponsors/dawsonfrakes", target: "_blank"}, "Sponsor on GitHub"),
          ),
        ),
      );
    };

    ReactDOMClient.createRoot(document.body).render(h(App));
  </script>
</body>
</html>
